<?xml version="1.0"?>
<project name="RDAHMM" default="RunRDAHMM" basedir=".">

<!--
<taskdef name="TransferFile" classname="commgrids.antwebtasks.TransferFile"/>
<taskdef name="MakeMovie" classname="commgrids.antwebtasks.AntServiceInvoker"/>
<taskdef name="AntEmail" classname="commgrids.antwebtasks.AntEmail"/>
-->

<target name="MakeWorkDir">
   <echo message="Creating ${workDir.prop}" />
   <mkdir dir="${workDir.prop}" />
</target>

<target name="ExecRDAHMM" depends="MakeWorkDir">
   <copy file="${modelWorkDir.prop}/${modelRDAHMMBaseName.prop}.A" 
         todir="${workDir.prop}"/>
   <copy file="${modelWorkDir.prop}/${modelRDAHMMBaseName.prop}.B" 
         todir="${workDir.prop}"/>
   <copy file="${modelWorkDir.prop}/${modelRDAHMMBaseName.prop}.pi" 
         todir="${workDir.prop}"/>
   <copy file="${modelWorkDir.prop}/${modelRDAHMMBaseName.prop}.L" 
         todir="${workDir.prop}"/>
   <copy file="${modelWorkDir.prop}/${modelRDAHMMBaseName.prop}.minval" 
         todir="${workDir.prop}"/>
   <copy file="${modelWorkDir.prop}/${modelRDAHMMBaseName.prop}.maxval" 
         todir="${workDir.prop}"/>
   <copy file="${modelWorkDir.prop}/${modelRDAHMMBaseName.prop}.range" 
         todir="${workDir.prop}"/>
   <copy file="${modelWorkDir.prop}/${modelRDAHMMBaseName.prop}.raw" 
         todir="${workDir.prop}"/>
   <echo message="Bin directory: ${bindir.prop}"/>
   <echo message="Number of observables: ${nobsv.prop}"/>
   <echo message="Dimension: ${ndim.prop}"/>
   <echo message="Number of States: ${nstates.prop}"/>
   <echo message="Output type: ${output_type.prop}"/>
   <echo message="Project base name: ${RDAHMMBaseName.prop}"/>
   <exec executable="${bindir.prop}/rdahmm" 
         output="${workDir.prop}/${RDAHMMBaseName.prop}.stdout"
			dir="${workDir.prop}">
      <arg line="-data ${workDir.prop}/${RDAHMMBaseName.prop}.input"/>
      <arg line="-T ${nobsv.prop}"/>
      <arg line="-D ${ndim.prop}"/>
      <arg line="-N ${nstates.prop}"/>
      <arg line="-output_type ${output_type.prop}"/>
      <arg line="-A ${workDir.prop}/${modelRDAHMMBaseName.prop}.A"/>
      <arg line="-B ${workDir.prop}/${modelRDAHMMBaseName.prop}.B"/>
	 <arg line="-pi ${workDir.prop}/${modelRDAHMMBaseName.prop}.pi"/>
      <arg line="-minvalfile ${workDir.prop}/${modelRDAHMMBaseName.prop}.minval"/>
      <arg line="-maxvalfile ${workDir.prop}/${modelRDAHMMBaseName.prop}.maxval"/>
      <arg line="-rangefile ${workDir.prop}/${modelRDAHMMBaseName.prop}.range"/>
      <arg line="-eval"/>
      <env key="PATH" path="${bindir.prop}:/bin/:$PATH"/>
   </exec>
</target>
<target name="CopyOutput" depends="ExecRDAHMM">
   <echo message="Creating ${outputDestDir.prop}" />
   <mkdir dir="${outputDestDir.prop}" />
   <copy todir="${outputDestDir.prop}">
     <fileset dir="${workDir.prop}"/>
   </copy>
   <copy file="${workDir.prop}/${RDAHMMBaseName.prop}.input" 
         todir="${bindir.prop}"/>
   <copy file="${workDir.prop}/${RDAHMMBaseName.prop}.Q" 
         todir="${bindir.prop}"/>
   <copy file="${workDir.prop}/${RDAHMMBaseName.prop}.raw" 
         todir="${bindir.prop}"/>
   <exec executable="cat"
				 output="${bindir.prop}/${RDAHMMBaseName.prop}.all.input"
         dir="${bindir.prop}">
      <arg line="${modelWorkDir.prop}/${modelRDAHMMBaseName.prop}.input ${RDAHMMBaseName.prop}.input"/>
      <env key="PATH" path="/usr/local/bin/:/bin/:/usr/bin/:$PATH"/>
   </exec>
   <exec executable="cat"
				 output="${bindir.prop}/${RDAHMMBaseName.prop}.all.Q"
         dir="${bindir.prop}">
      <arg line="${modelWorkDir.prop}/${modelRDAHMMBaseName.prop}.Q ${RDAHMMBaseName.prop}.Q"/>
      <env key="PATH" path="/usr/local/bin/:/bin/:/usr/bin/:$PATH"/>
   </exec>
   <exec executable="cat"
				 output="${bindir.prop}/${RDAHMMBaseName.prop}.all.raw"
         dir="${bindir.prop}">
      <arg line="${modelWorkDir.prop}/${modelRDAHMMBaseName.prop}.raw ${RDAHMMBaseName.prop}.raw"/>
      <env key="PATH" path="/usr/local/bin/:/bin/:/usr/bin/:$PATH"/>
   </exec>
</target>

<target name="ExecGnuplot" depends="CopyOutput">
   <exec executable="${bindir.prop}/plot_go.sh"
         dir="${bindir.prop}">
      <arg line="${RDAHMMBaseName.prop}.all.input"/>
      <arg line="${RDAHMMBaseName.prop}.all.Q"/>
      <arg line="${RDAHMMBaseName.prop}.all.raw"/>
      <env key="PATH" path="${bindir.prop}:/usr/local/bin/:/bin/:/usr/bin/:$PATH"/>
   </exec>
   <move todir="${outputDestDir.prop}">
     <fileset file="${RDAHMMBaseName.prop}.all.*"/>
   </move>
   <delete>
    <fileset file="${RDAHMMBaseName.prop}.*"/>
   </delete>
</target>

<target name="ExecMultiGnuplot" depends="CopyOutput">
   <exec executable="${bindir.prop}/plot_multisite.sh"
         dir="${bindir.prop}">
      <arg line="-x ${RDAHMMBaseName.prop}.input"/>
      <arg line="-q ${RDAHMMBaseName.prop}.Q"/>
      <arg line="-w ${workDir.prop}"/>
      <arg line="-l '${stationList.prop}'"/>
      <env key="PATH" path="${bindir.prop}:/bin/:/usr/bin/:$PATH"/>
   </exec>
   <move todir="${outputDestDir.prop}">
     <fileset file="${RDAHMMBaseName.prop}.*.png"/>
   </move>
</target>

<target name="RunRDAHMM" depends="ExecGnuplot">
   <echo message="RDAHMM run completed"/>
</target>
</project>



