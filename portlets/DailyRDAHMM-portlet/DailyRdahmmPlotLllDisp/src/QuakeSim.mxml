<?xml version="1.0" encoding="utf-8"?>
<mx:Application xmlns:mx="http://www.adobe.com/2006/mxml" layout="absolute" xmlns:components="components.*"
	creationComplete="init();" xmlns:code="http://code.google.com/p/flexlib/" currentState="Longitude">
		<mx:states>
				<mx:State name="Longitude">
						<!-- mx:SetProperty target="{stateToggle}" name="selectedIndex" value="0"/ -->
						<mx:RemoveChild target="{eastChart}"/>
						<mx:RemoveChild target="{upChart}"/>
						<mx:RemoveChild target="{hboxLat}"/>
						<mx:RemoveChild target="{hboxHgt}"/>						
				</mx:State>
				<mx:State name="Latitude">
						<mx:RemoveChild target="{northChart}"/>
						<mx:RemoveChild target="{upChart}"/>
						<!-- mx:SetProperty target="{stateToggle}" name="selectedIndex" value="1"/ -->
						<mx:RemoveChild target="{hboxLon}"/>
						<mx:RemoveChild target="{hboxHgt}"/>
				</mx:State>
				<mx:State name="Height">
						<!-- mx:SetProperty target="{stateToggle}" name="selectedIndex" value="2"/ -->
						<mx:RemoveChild target="{northChart}"/>
						<mx:RemoveChild target="{eastChart}"/>
						<mx:RemoveChild target="{hboxLat}"/>
						<mx:RemoveChild target="{hboxLon}"/>
				</mx:State>
		</mx:states>
		<mx:Script>
		<![CDATA[	
			import mx.collections.ArrayCollection;
			import mx.controls.Alert;
			import mx.rpc.events.ResultEvent;
			import mx.utils.ObjectUtil;
		
			[Bindable] public var northData:ArrayCollection = new ArrayCollection();
			[Bindable] public var eastData: ArrayCollection = new ArrayCollection();
			[Bindable] public var upData:ArrayCollection = new ArrayCollection();
			[Bindable] public var dateArray:Array = new Array();
			[Bindable] public var stationID:String;
			[Bindable] public var lat:String;
			[Bindable] public var long:String;
			[Bindable] public var hgt:String;
			[Bindable] public var minNorth:Number;
			[Bindable] public var minEast:Number;
			[Bindable] public var minUp:Number;
			[Bindable] public var maxNorth:Number;
			[Bindable] public var maxEast:Number;
			[Bindable] public var maxUp:Number;
			[Bindable] public var minNorthDisp:Number;
			[Bindable] public var minEastDisp:Number;
			[Bindable] public var minUpDisp:Number;
			[Bindable] public var maxNorthDisp:Number;
			[Bindable] public var maxEastDisp:Number;
			[Bindable] public var maxUpDisp:Number;
			[Bindable] public var maxValLen:Number;
			[Bindable] public var maxDispLen:Number;
			
			private const millisecondsPerDay:int = 1000 * 60 * 60 * 24;
			
			private function init():void
			{
				this.stationID = Application.application.parameters.stationID;
				this.lat = Application.application.parameters.lat;
				this.long = Application.application.parameters.long;
				this.hgt = Application.application.parameters.hgt;
				this.labelLonDisp.percentWidth = 100;
				this.labelLatDisp.percentWidth = 100;
				this.labelHgtDisp.percentWidth = 100;
				this.maxDispLen = 0;
				this.maxValLen = 0;				
				this.getInfo.url = Application.application.parameters.url;
				this.getInfo.send();
			}
		
			protected function getInfo_resultHandler(event:ResultEvent):void
			{
				// TODO Auto-generated method stub
				var tempNorth:ArrayCollection = new ArrayCollection();
				var tempEast:ArrayCollection = new ArrayCollection();
				var tempUp:ArrayCollection = new ArrayCollection();
				
				var dayArray:Array = event.result.toString().split('\n');
				dayArray = dayArray.slice(0,dayArray.length-1);
				
				var beginDate:Date;
				var closeDate:Date;
				for each (var currDay:String in dayArray)
				{
					var currDayArray:Array = currDay.split(' ');
					var temp:Object = new Object();
					temp.state = currDayArray[0];
					var dateArray:Array = String(currDayArray[1]).split('-');
					temp.date = new Date(dateArray[0],dateArray[1]-1,dateArray[2]);
					
					if (!beginDate)
					{
						beginDate = temp.date;
					}
					closeDate = temp.date;
					this.dateArray.push(temp.date);
					var northVal:Number = Number(currDayArray[2]);
					var eastVal:Number = Number(currDayArray[3]);
					var upVal:Number = Number(currDayArray[4]);
					var northDisp:Number = Number(currDayArray[5]);
					var eastDisp:Number = Number(currDayArray[6]);
					var upDisp:Number = Number(currDayArray[7]);
				 	
				 	if ((!minNorth) || (northVal < minNorth))
						minNorth = northVal;
					if ((!minEast) || (eastVal < minEast))
						minEast = eastVal;
					if ((!minUp) || (upVal < minUp))
						minUp = upVal;
					if ((!maxNorth) || (northVal > maxNorth))
						maxNorth = northVal;
					if ((!maxEast) || (eastVal > maxEast))
						maxEast = eastVal;
					if ((!maxUp) || (upVal > maxUp))
						maxUp = upVal;
						
					if ((!minNorthDisp) || (northDisp < minNorthDisp))
						minNorthDisp = northDisp;
					if ((!minEastDisp) || (eastDisp < minEastDisp))
						minEastDisp = eastDisp;
					if ((!minUpDisp) || (upDisp < minUpDisp))
						minUpDisp = upDisp;
					if ((!maxNorthDisp) || (northDisp > maxNorthDisp))
						maxNorthDisp = northDisp;
					if ((!maxEastDisp) || (eastDisp > maxEastDisp))
						maxEastDisp = eastDisp;
					if ((!maxUpDisp) || (upDisp > maxUpDisp))
						maxUpDisp = upDisp;
						
					if (maxValLen < (currDayArray[2] as String).length) {
						maxValLen = (currDayArray[2] as String).length;
					}
					if (maxValLen < (currDayArray[3] as String).length) {
						maxValLen = (currDayArray[3] as String).length;
					}
					if (maxValLen < (currDayArray[4] as String).length) {
						maxValLen = (currDayArray[4] as String).length;
					}
					if (maxDispLen < (currDayArray[5] as String).length) {
						maxDispLen = (currDayArray[5] as String).length;
					}
					if (maxDispLen < (currDayArray[6] as String).length) {
						maxDispLen = (currDayArray[6] as String).length;
					}
					if (maxDispLen < (currDayArray[7] as String).length) {
						maxDispLen = (currDayArray[7] as String).length;
					}
					
					switch (temp.state)
					{
						case '1':
							temp.value = Number(currDayArray[2]);
							temp.value1 = Number(currDayArray[2]);
							temp.valueDisp = Number(currDayArray[5]);
							temp.value7 = 0;
							tempNorth.addItem(ObjectUtil.copy(temp));
							temp.value = Number(currDayArray[3]);
							temp.value1 = Number(currDayArray[3]);
							temp.valueDisp = Number(currDayArray[6]);
							temp.value7 = 0;
							tempEast.addItem(ObjectUtil.copy(temp));
							temp.value = Number(currDayArray[4]);
							temp.value1 = Number(currDayArray[4]);
							temp.valueDisp = Number(currDayArray[7]);
							temp.value7 = 0;
							tempUp.addItem(ObjectUtil.copy(temp));
							break;
						case '2':
							temp.value = Number(currDayArray[2]);
							temp.value2 = Number(currDayArray[2]);
							temp.valueDisp = Number(currDayArray[5]);
							temp.value7 = 0;
							tempNorth.addItem(ObjectUtil.copy(temp));
							temp.value = Number(currDayArray[3]);
							temp.value2 = Number(currDayArray[3]);
							temp.valueDisp = Number(currDayArray[6]);
							temp.value7 = 0;
							tempEast.addItem(ObjectUtil.copy(temp));
							temp.value = Number(currDayArray[4]);
							temp.value2 = Number(currDayArray[4]);
							temp.valueDisp = Number(currDayArray[7]);
							temp.value7 = 0;
							tempUp.addItem(ObjectUtil.copy(temp));
							break;
						case '3':
							temp.value = Number(currDayArray[2]);
							temp.value3 = Number(currDayArray[2]);
							temp.valueDisp = Number(currDayArray[5]);
							temp.value7 = 0;
							tempNorth.addItem(ObjectUtil.copy(temp));
							temp.value = Number(currDayArray[3]);
							temp.value3 = Number(currDayArray[3]);
							temp.valueDisp = Number(currDayArray[6]);
							temp.value7 = 0;
							tempEast.addItem(ObjectUtil.copy(temp));
							temp.value = Number(currDayArray[4]);
							temp.value3 = Number(currDayArray[4]);
							temp.valueDisp = Number(currDayArray[7]);
							temp.value7 = 0;
							tempUp.addItem(ObjectUtil.copy(temp));
							break;
						case '4':
							temp.value = Number(currDayArray[2]);
							temp.value4 = Number(currDayArray[2]);
							temp.valueDisp = Number(currDayArray[5]);
							temp.value7 = 0;
							tempNorth.addItem(ObjectUtil.copy(temp));
							temp.value = Number(currDayArray[3]);
							temp.value4 = Number(currDayArray[3]);
							temp.valueDisp = Number(currDayArray[6]);
							temp.value7 = 0;
							tempEast.addItem(ObjectUtil.copy(temp));
							temp.value = Number(currDayArray[4]);
							temp.value4 = Number(currDayArray[4]);
							temp.valueDisp = Number(currDayArray[7]);
							temp.value7 = 0;
							tempUp.addItem(ObjectUtil.copy(temp));
							break;
						case '5':
							temp.value = Number(currDayArray[2]);
							temp.value5 = Number(currDayArray[2]);
							temp.valueDisp = Number(currDayArray[5]);
							temp.value7 = 0;
							tempNorth.addItem(ObjectUtil.copy(temp));
							temp.value = Number(currDayArray[3]);
							temp.value5 = Number(currDayArray[3]);
							temp.valueDisp = Number(currDayArray[6]);
							temp.value7 = 0;
							tempEast.addItem(ObjectUtil.copy(temp));
							temp.value = Number(currDayArray[4]);
							temp.value5 = Number(currDayArray[4]);
							temp.valueDisp = Number(currDayArray[7]);
							temp.value7 = 0;
							tempUp.addItem(ObjectUtil.copy(temp));
							break;
						case '6':
							temp.value = Number(currDayArray[2]);
							temp.value6 = Number(currDayArray[2]);
							temp.valueDisp = Number(currDayArray[5]);
							temp.value7 = 0;
							tempNorth.addItem(ObjectUtil.copy(temp));
							temp.value = Number(currDayArray[3]);
							temp.value6 = Number(currDayArray[3]);
							temp.valueDisp = Number(currDayArray[6]);
							temp.value7 = 0;
							tempEast.addItem(ObjectUtil.copy(temp));
							temp.value = Number(currDayArray[4]);
							temp.value6 = Number(currDayArray[4]);
							temp.valueDisp = Number(currDayArray[7]);
							temp.value7 = 0;
							tempUp.addItem(ObjectUtil.copy(temp));
					}
				}
				
				northData = tempNorth;
				eastData = tempEast;
				upData = tempUp;
				
				dateRange.minimum = beginDate.getTime();
				dateRange.maximum = closeDate.getTime();
				dateRange.values = [beginDate.getTime(), closeDate.getTime()]
				dateRange.snapInterval = millisecondsPerDay;
				startDate.selectedDate = beginDate;
				endDate.selectedDate = closeDate;
			}
			
			private function dateChange():void
			{
				startDate.selectedDate = new Date(dateRange.values[0]);
				endDate.selectedDate = new Date(dateRange.values[1]);
			}
			
			private function startChange():void
			{
				var temp:Array = dateRange.values;
				temp[0] = startDate.selectedDate.getTime();
				dateRange.values = temp;
				updateGraphs();
			}

			private function endChange():void
			{
				var temp:Array = dateRange.values;
				temp[1] = endDate.selectedDate.getTime();
				dateRange.values = temp;
				updateGraphs();
			}
			
			private function updateGraphs():void
			{
				northChart.updateGraph();
				eastChart.updateGraph();
				upChart.updateGraph();
			}
			
			private function stateChange():void
			{
				switch (stateToggle.selectedIndex)
				{
					case 0: this.setCurrentState('Longitude');
						break;
					case 1: this.setCurrentState('Latitude');
						break;
					case 2: this.setCurrentState('Height');
						break;
					case 3: this.setCurrentState('');
						break;
				}
			}
		]]>
	</mx:Script>
	<mx:HTTPService id="getInfo" url="feeds/testInfo" result="getInfo_resultHandler(event)" resultFormat="text"/>
	<mx:Panel height="100%" width="100%" title="Station: {stationID}  Reference point: [Longitude {long}, Latitude {lat}, Height {hgt}]">
		<mx:VBox height="100%" width="100%">
			<mx:ToggleButtonBar selectedIndex="0" id="stateToggle" itemClick="stateChange();">
				<mx:dataProvider>
					<mx:Array>
						<mx:String>Longitude</mx:String>
						<mx:String>Latitude</mx:String>
						<mx:String>Height</mx:String>
						<mx:String>All</mx:String>
					</mx:Array>
				</mx:dataProvider>
			</mx:ToggleButtonBar>
			
			<mx:VBox id="plotsVbox" width="100%" height="100%">
				<mx:HBox width="100%" id="hboxLon">
					<mx:Label text="East-West displacement (meters)" id="labelLonDisp"/>
					<mx:Label text="Longitude (degrees)" id="labelLon"/>
				</mx:HBox>
				<components:rdahmmLineChart  data="{northData}" id="northChart" minVal="{minNorth}" maxVal="{maxNorth}" minDisp="{minNorthDisp}" maxDisp="{maxNorthDisp}"
					maxValLen="{maxValLen}" maxDispLen="{maxDispLen}" height="100%" width="100%" beginDate="{startDate.selectedDate}" endDate="{endDate.selectedDate}"/>
				<mx:HBox width="100%" id="hboxLat">
					<mx:Label text="North-South displacement (meters)" id="labelLatDisp"/>
					<mx:Label text="Latitude (degrees)" id="labelLat"/>
				</mx:HBox>
				<components:rdahmmLineChart data="{eastData}" id="eastChart" minVal="{minEast}" maxVal="{maxEast}" minDisp="{minEastDisp}" maxDisp="{maxEastDisp}" 
					maxValLen="{maxValLen}" maxDispLen="{maxDispLen}" height="100%" width="100%" beginDate="{startDate.selectedDate}" endDate="{endDate.selectedDate}"/>
				<mx:HBox width="100%" id="hboxHgt">
					<mx:Label text="Up-Down displacement (meters)" id="labelHgtDisp"/>
					<mx:Label text="Height (meters)" id="labelHgt"/>
				</mx:HBox>
				<components:rdahmmLineChart data="{upData}" id="upChart" minVal="{minUp}" maxVal="{maxUp}" minDisp="{minUpDisp}" maxDisp="{maxUpDisp}" 
					maxValLen="{maxValLen}" maxDispLen="{maxDispLen}" height="100%" width="100%" beginDate="{startDate.selectedDate}" endDate="{endDate.selectedDate}"/>			
			</mx:VBox>
			<!--<mx:LineChart id="timeChart" dataProvider="{upData}" height="30" verticalAxisStyleNames="tickPlacement:none" horizontalAxisStyleNames="tickPlacement:none,">
					<mx:series>
						<mx:LineSeries displayName="Series 1" yField="value"/>
					</mx:series>
				</mx:LineChart>-->
			<code:HSlider id="dateRange" allowThumbOverlap="false" thumbCount="2" showDataTip="false"
				liveDragging="true" lockRegionsWhileDragging="true"
				change="dateChange();" width="100%" 
				showTrackHighlight="true" tickThickness="1" mouseUp="updateGraphs()"/>
			
			<mx:Canvas width="100%">
				<mx:Label text="Start Date:"/>
	            <mx:DateField id="startDate" change="startChange()" x="65"/>
	            <mx:Label text="End Date:" id="label4" right="65"/>
	            <mx:DateField id="endDate" change="endChange()" right="10"/>
			</mx:Canvas>		
             
		</mx:VBox>
	</mx:Panel>
</mx:Application>
