<?xml version="1.0" encoding="utf-8"?>
<mx:Application xmlns:mx="http://www.adobe.com/2006/mxml" creationComplete="init()" width="100%" height="100%" xmlns:comp="components.*">
	<mx:Script>
		<![CDATA[
			import mx.charts.HitData;
			import flash.utils.getTimer;
			import mx.charts.chartClasses.DataDescription;
			import mx.formatters.DateFormatter;
			import mx.events.ScrollEvent;
			import mx.controls.Alert;
			import mx.collections.ArrayCollection;
			import mx.rpc.events.ResultEvent;
			import mx.charts.renderers.*;
						
			[Bindable]
			private var statesArray:Array = new Array();
			[Bindable]
			private var infoArray:Array = new Array();
			[Bindable]
			private var dataArray:ArrayCollection = new ArrayCollection;
			[Bindable]
			private var toBeUsedArray:ArrayCollection = new ArrayCollection();
			private var dateRange:int = 0;
			[Bindable] private var beginDate:Date = new Date();
			[Bindable] private var firstDate:Date = new Date();
			[Bindable] private var lastDate:Date = new Date();
			private var direction:String = 'x';
			
			public static const millisecondsPerDay:int = 1000 * 60 * 60 * 24;
			
			private function init():void {
				this.getStateDataHTTP.request.stationname = "blyt";
				this.getStateDataHTTP.request.date = "2010-01-17";
				this.getRawDataHTTP.request.stationname = "blyt";
				this.getRawDataHTTP.request.date = "2010-01-17";
				getStateDataHTTP.send();
				
			}			
			private function stateDataHandler(event:ResultEvent):void
			{
				this.statesArray = String(event.result).split('\n');
				getRawDataHTTP.send();
			}
			
			private function rawDataHandler(event:ResultEvent):void
			{
				var infoArray:Array = String(event.result).split('\n');
				for each (var currLine:String in infoArray)
				{
					var tempArray:Array = currLine.split(' ');
					var dateTimeArray:Array = String(tempArray[1]).split('T');
					var dateArray:Array = String(dateTimeArray[0]).split('-');
					var timeArray:Array = String(dateTimeArray[1]).split(':');
					tempArray[1] = new Date(Number(dateArray[0]), Number(dateArray[1])-1, Number(dateArray[2]),Number(timeArray[0]),Number(timeArray[1]),Number(timeArray[2]));
					for(var x:int = 0 ; x<tempArray.length ; x = x + 1)
					{
						if (x <= 1) { continue; }
						tempArray[x] = Number(tempArray[x]);
					}
					var plotData:Array = new Array();
					
					this.dataArray.addItem(tempArray);
					
				}

				var xlowValue:Number = Number(this.dataArray[0][2]);
				var xhighValue:Number = xlowValue;
				var ylowValue:Number = Number(this.dataArray[0][3]);
				var yhighValue:Number = ylowValue;
				var zlowValue:Number = Number(this.dataArray[0][4]);
				var zhighValue:Number = zlowValue;
				
				for (x=1 ; x<this.dataArray.length ; x++)
				{
					if (Number(this.dataArray[x][2]) < xlowValue)
					{
						xlowValue = Number(this.dataArray[x][2]);
					}
					if (Number(this.dataArray[x][2]) > xhighValue)
					{
						xhighValue = Number(this.dataArray[x][2]);
					}
					if (Number(this.dataArray[x][3]) < ylowValue)
					{
						ylowValue = Number(this.dataArray[x][3]);
					}
					if (Number(this.dataArray[x][3]) > yhighValue)
					{
						yhighValue = Number(this.dataArray[x][3]);
					}
					if (Number(this.dataArray[x][4]) < zlowValue)
					{
						zlowValue = Number(this.dataArray[x][4]);
					}
					if (Number(this.dataArray[x][4]) > zhighValue)
					{
						zhighValue = Number(this.dataArray[x][4]);
					}
				}
				var toBeUsedArray:ArrayCollection = new ArrayCollection();
				for (x=0 ; x<this.dataArray.length ; x++)
				{
					var tempObj:Object;
					switch (int(this.statesArray[x]))
					{
						case 0 : 
							tempObj = new Object();
							
							tempObj.value = this.dataArray[x][2];
							tempObj.velocity = this.dataArray[x][5];
							tempObj.date = this.dataArray[x][1];
							tempObj.value0 = Number(this.dataArray[x][2])-xlowValue;
							tempObj.direction = 'x';
							toBeUsedArray.addItem(tempObj);
							tempObj = new Object();
							tempObj.value = this.dataArray[x][3];
							tempObj.velocity = this.dataArray[x][6];
							tempObj.date = this.dataArray[x][1];
							tempObj.value0 = Number(this.dataArray[x][3])-ylowValue;
							tempObj.direction = 'y';
						//	toBeUsedArray.addItem(tempObj);
							tempObj = new Object();
							tempObj.value = this.dataArray[x][4];
							tempObj.velocity = this.dataArray[x][7];
							tempObj.date = this.dataArray[x][1];
							tempObj.value0 = Number(this.dataArray[x][4])-zlowValue;
							tempObj.direction = 'z';
						//	toBeUsedArray.addItem(tempObj);
							break;
						case 1 : 
							tempObj = new Object();
							tempObj.value = this.dataArray[x][2];
							tempObj.velocity = this.dataArray[x][5];
							tempObj.date = this.dataArray[x][1];
							tempObj.value1 = Number(this.dataArray[x][2])-xlowValue;
							tempObj.direction = 'x';
							toBeUsedArray.addItem(tempObj);
							tempObj = new Object();
							tempObj.value = this.dataArray[x][3];
							tempObj.velocity = this.dataArray[x][6];
							tempObj.date = this.dataArray[x][1];
							tempObj.value1 = Number(this.dataArray[x][3])-ylowValue;
							tempObj.direction = 'y';
							//toBeUsedArray.addItem(tempObj);
							tempObj = new Object();
							tempObj.value = this.dataArray[x][4];
							tempObj.velocity = this.dataArray[x][7];
							tempObj.date = this.dataArray[x][1];
							tempObj.value1 = Number(this.dataArray[x][4])-zlowValue;
							tempObj.direction = 'z';
							//toBeUsedArray.addItem(tempObj);
							break;
						case 2 : 
							tempObj = new Object();
							tempObj.value = this.dataArray[x][2];
							tempObj.velocity = this.dataArray[x][5];
							tempObj.date = this.dataArray[x][1];
							tempObj.value2 = Number(this.dataArray[x][2])-xlowValue;
							tempObj.direction = 'x';
							toBeUsedArray.addItem(tempObj);
							tempObj = new Object();
							tempObj.value = this.dataArray[x][3];
							tempObj.velocity = this.dataArray[x][6];
							tempObj.date = this.dataArray[x][1];
							tempObj.value2 = Number(this.dataArray[x][3])-ylowValue;
							tempObj.direction = 'y';
							//toBeUsedArray.addItem(tempObj);
							tempObj = new Object();
							tempObj.value = this.dataArray[x][4];
							tempObj.velocity = this.dataArray[x][7];
							tempObj.date = this.dataArray[x][1];
							tempObj.value2 = Number(this.dataArray[x][4])-zlowValue;
							tempObj.direction = 'z';
							//toBeUsedArray.addItem(tempObj);
							break;
						case 3 : 
							tempObj = new Object();
							tempObj.value = this.dataArray[x][2];
							tempObj.velocity = this.dataArray[x][5];
							tempObj.date = this.dataArray[x][1];
							tempObj.value3 = Number(this.dataArray[x][2])-xlowValue;
							tempObj.direction = 'x';
							toBeUsedArray.addItem(tempObj);
							tempObj = new Object();
							tempObj.value = this.dataArray[x][3];
							tempObj.velocity = this.dataArray[x][6];
							tempObj.date = this.dataArray[x][1];
							tempObj.value3 = Number(this.dataArray[x][3])-ylowValue;
							tempObj.direction = 'y';
						//	toBeUsedArray.addItem(tempObj);
							tempObj = new Object();
							tempObj.value = this.dataArray[x][4];
							tempObj.velocity = this.dataArray[x][7];
							tempObj.date = this.dataArray[x][1];
							tempObj.value3 = Number(this.dataArray[x][4])-zlowValue;
							tempObj.direction = 'z';
						//	toBeUsedArray.addItem(tempObj);
							break;
						case 4 : 
							tempObj = new Object();
							tempObj.value = this.dataArray[x][2];
							tempObj.velocity = this.dataArray[x][5];
							tempObj.date = this.dataArray[x][1];
							tempObj.value4 = Number(this.dataArray[x][2])-xlowValue;
							tempObj.direction = 'x';
						//	toBeUsedArray.addItem(tempObj);
							tempObj = new Object();
							tempObj.value = this.dataArray[x][3];
							tempObj.velocity = this.dataArray[x][6];
							tempObj.date = this.dataArray[x][1];
							tempObj.value4 = Number(this.dataArray[x][3])-ylowValue;
							tempObj.direction = 'y';
						//	toBeUsedArray.addItem(tempObj);
							tempObj = new Object();
							tempObj.value = this.dataArray[x][4];
							tempObj.velocity = this.dataArray[x][7];
							tempObj.date = this.dataArray[x][1];
							tempObj.value4 = Number(this.dataArray[x][4])-zlowValue;
							tempObj.direction = 'z';
						//	toBeUsedArray.addItem(tempObj);
							break;
						case 5 : 
							tempObj = new Object();
							tempObj.value = this.dataArray[x][2];
							tempObj.velocity = this.dataArray[x][5];
							tempObj.date = this.dataArray[x][1];
							tempObj.value5 = Number(this.dataArray[x][2])-xlowValue;
							tempObj.direction = 'x';
							toBeUsedArray.addItem(tempObj);
							tempObj = new Object();
							tempObj.value = this.dataArray[x][3];
							tempObj.velocity = this.dataArray[x][6];
							tempObj.date = this.dataArray[x][1];
							tempObj.value5 = Number(this.dataArray[x][3])-ylowValue;
							tempObj.direction = 'y';
						//	toBeUsedArray.addItem(tempObj);
							tempObj = new Object();
							tempObj.value = this.dataArray[x][4];
							tempObj.velocity = this.dataArray[x][7];
							tempObj.date = this.dataArray[x][1];
							tempObj.value5 = Number(this.dataArray[x][4])-zlowValue;
							tempObj.direction = 'z';
						//	toBeUsedArray.addItem(tempObj);
							break;
					}
				}
				this.firstDate.setTime((toBeUsedArray[0].date as Date).getTime());
				this.beginDate.setTime((toBeUsedArray[0].date as Date).getTime());
				this.lastDate.setTime((toBeUsedArray[toBeUsedArray.length-1].date as Date).getTime())
				this.dataArray = toBeUsedArray;
				this.dataArray.filterFunction = dataFilter;
				dataArray.refresh();
				xGraph.graphData = this.dataArray;
			}
			
			private function dataFilter(item:Object):Boolean
			{
				if (item.direction != direction)
				{
					return false;
				}
				if (dateRange == 0)
				{
					return true;
				}
				var endDate:Date = new Date();
				endDate.setTime(beginDate.getTime() + (millisecondsPerDay*dateRange));
				
				if (((item.date as Date) > beginDate) && ((item.date as Date) < endDate)) 
				{
					return true;
				}  
				return false;
			}
			
			private function testor():void
			{
				
			}
			
			private function navigate(method:String):void
			{
				
				switch (method)
				{
					case 'prev' :
						beginDate.setTime(beginDate.getTime()-(millisecondsPerDay*dateRange*.2));
						if (beginDate.getTime() <= firstDate.getTime())
						{
							beginDate.setTime(firstDate.getTime());
						}
						break;
					case 'next' :
						beginDate.setTime(beginDate.getTime()+(millisecondsPerDay*dateRange*.2));
						if ((beginDate.getTime()) >= lastDate.getTime()- millisecondsPerDay*dateRange)
						{
							beginDate.setTime(lastDate.getTime()- millisecondsPerDay*dateRange);
						}
						break;
				}
				
			}
			
			private function dataTipView(hitData:HitData):String
			{
				return (hitData.item.date as Date).toDateString()+"\n"+hitData.item.value+"\nVelocity : "+hitData.item.velocity;

			}


		]]>
	</mx:Script>
	
<!--Define Custom Color-->
	
	<mx:Stroke id="s1" color="red" weight="4"/>
	<mx:Stroke id="s2" color="green" weight="4"/>
	<mx:Stroke id="s3" color="blue" weight="4"/>
	<mx:Stroke id="s4" color="purple" weight="4"/>
	<mx:Stroke id="s5" color="cyan" weight="4"/>
	
	<!--Define Solid Color-->
	
	<mx:SolidColor id="f1" color="red"/>
	<mx:SolidColor id="f2" color="green"/>
	<mx:SolidColor id="f3" color="blue"/>
	<mx:SolidColor id="f4" color="purple"/>
	<mx:SolidColor id="f5" color="cyan"/>
	
<!--	<mx:Panel width="95%" height="100%" layout="vertical" horizontalAlign="center" title="Daily RDAHMM GPS Data Analysis">
	<mx:ToggleButtonBar id="axisToggle" selectedIndex="0" itemClick="if (axisToggle.selectedIndex ==0 ) { direction = 'x'; dataArray.refresh(); } else if ( axisToggle.selectedIndex == 1) { direction = 'y'; dataArray.refresh(); } else { direction = 'z'; dataArray.refresh();  }">
	
	    <mx:dataProvider>
		    <mx:String>North</mx:String>
			<mx:String>East</mx:String>
			<mx:String>Up</mx:String>	
	    </mx:dataProvider>
		
	</mx:ToggleButtonBar>
	
		

	
	
	<mx:HBox>
		<mx:LinkButton label="1w" toolTip="1 Week" click="dateRange = 7; beginDate.setTime(String(new Date().getTime()- (millisecondsPerDay*dateRange))); dataArray.refresh();"/>
		<mx:LinkButton label="2w" toolTip="2 Weeks" click="dateRange = 14; beginDate.setTime(new Date().getTime()- (millisecondsPerDay*dateRange)); dataArray.refresh();"/>
		<mx:LinkButton label="1m" toolTip="1 Month" click="dateRange = 30; beginDate.setTime(String(new Date().getTime()- (millisecondsPerDay*dateRange))); dataArray.refresh();"/>
		<mx:LinkButton label="2m" toolTip="2 Months" click="dateRange = 60; beginDate.setTime(new Date().getTime()- (millisecondsPerDay*dateRange)); dataArray.refresh();"/>
		<mx:LinkButton label="6m" toolTip="6 Months" click="dateRange = 180; beginDate.setTime(new Date().getTime()- (millisecondsPerDay*dateRange)); dataArray.refresh();"/>
		<mx:LinkButton label="YTD" toolTip="Year to Date" click="var tempDate:Date = new Date(new Date().fullYear,0,1); dateRange = ((new Date().getTime() - tempDate.getTime()) * millisecondsPerDay); beginDate.setTime(new Date().getTime()- (millisecondsPerDay*dateRange)); dataArray.refresh();"/>
		<mx:LinkButton label="1Y" toolTip="1 Year" click="dateRange = 365; beginDate.setTime(new Date().getTime()- (millisecondsPerDay*dateRange)); dataArray.refresh();"/>
		<mx:LinkButton label="2Y" toolTip="2 Years" click="dateRange = 365*2; beginDate.setTime(new Date().getTime()- (millisecondsPerDay*dateRange)); dataArray.refresh();"/>
		<mx:LinkButton label="5Y" toolTip="5 Years" click="dateRange = 365*5; beginDate.setTime(new Date().getTime()- (millisecondsPerDay*dateRange)); dataArray.refresh();"/>
		<mx:LinkButton label="max" toolTip="All" click="dateRange = 0; dataArray.refresh();"/>
	</mx:HBox>
	<mx:LineChart 
		click="testor()"
		id="plotchart1"
		width="100%" 
		height="100%" 
		showDataTips="true" 
		dataTipFunction="dataTipView"
		dataProvider="{dataArray}"
		paddingBottom="5" paddingLeft="5" paddingRight="5" paddingTop="5">
		<mx:horizontalAxis>
			<mx:DateTimeAxis />
		</mx:horizontalAxis>
		
		<mx:series>
			
			<mx:LineSeries 
				displayName="State 1" 
				yField="value1" 
				xField="date" 
				lineStroke="{s1}" 
				fill="{f1}"
				 />
			<mx:LineSeries 
				displayName="State 2" 
				yField="value2" 
				xField="date" 
				lineStroke="{s2}"
				fill="{f2}" />
			<mx:LineSeries 
				displayName="State 3" 
				yField="value3" 
				xField="date" 
				lineStroke="{s3}" 
				fill="{f3}" />
			<mx:LineSeries displayName="State 4" 
				yField="value4" 
				xField="date"
				lineStroke="{s4}" 
				fill="{f4}" />
			<mx:LineSeries 
				displayName="State 5" 
				yField="value5" 
				xField="date" 
				lineStroke="{s5}" 
				fill="{f5}" />
		</mx:series>
		
	</mx:LineChart>
	
	
	
	<mx:HBox>
		<mx:Text text="prev" click="navigate('prev'); dataArray.refresh()"/>
		<mx:Text text="next" click="navigate('next'); dataArray.refresh()"/>
	</mx:HBox>
	
	
	<mx:Text id="showposition" width="50%" height="100">
		
	</mx:Text>
	<mx:Panel layout="vertical" horizontalAlign="center" verticalAlign="middle">
		
	<mx:Legend click="testor()" dataProvider="{plotchart1}" width="100%" direction="horizontal" markerHeight="30" markerWidth="30" fontSize="20"/>
	</mx:Panel>
	
	</mx:Panel>
-->	
		
            <mx:VBox label="North">
				<comp:lineGraphPanel
						
						height="100%"
						width="100%"
						verticalAlign="middle"
						layout="vertical" 
						id="xGraph"
						
				/>
            </mx:VBox>
	<mx:HTTPService 
		id="getRawDataHTTP" url="http://gw19.quarry.iu.teragrid.org/Gadgets/Google/getRawData.php" 
		resultFormat="array" result="rawDataHandler(event)"/>
	<mx:HTTPService 
		id="getStateDataHTTP" url="http://gw19.quarry.iu.teragrid.org/Gadgets/Google/getStatesData.php" 
		resultFormat="array" result="stateDataHandler(event)"/>		
	
	
</mx:Application>
